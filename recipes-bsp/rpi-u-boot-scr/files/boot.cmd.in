setenv dev_number 0;
setenv phram_addr @@QUINCE_PHRAM_ADDR@@;
setenv phram_size @@QUINCE_PHRAM_SIZE@@;
setenv rootfs_img_file @@QUINCE_ROOTFS_IMG_FILE@@;
setenv opt_img_file @@QUINCE_OPT_IMG_FILE@@;

# Load bootargs from Device Tree Blob
fdt addr ${fdt_addr}
fdt get value bootargs /chosen bootargs

# Load Linux Kernel
echo Loading @@KERNEL_IMAGETYPE@@...
load @@BOOT_MEDIA@@ ${dev_number}:1 ${kernel_addr_r} @@KERNEL_IMAGETYPE@@;

if test -e ${phram_addr} && test -e ${phram_size}; then
    if test -e ${rootfs_img_file} && test -e @@BOOT_MEDIA@@ ${dev_number}:2 ${rootfs_img_file}; then
        # Check phram size for rootfs
        setenv rest_phram_size ${phram_size};
        size @@BOOT_MEDIA@@ ${dev_number}:2 ${rootfs_img_file};
        setenv rootfs_img_size 0x${filesize}

        if test ${rest_phram_size} -ge ${rootfs_img_size}; then
            # Load rootfs image file
            setenv rootfs_img_addr ${phram_addr}
            echo Loading ${rootfs_img_file}... (addr=${rootfs_img_addr} size=${rootfs_img_size})
            load @@BOOT_MEDIA@@ ${dev_number}:2 ${rootfs_img_addr} ${rootfs_img_file};
            setenv bootargs ${bootargs} phram.phram=/,${rootfs_img_addr},${rootfs_img_size} root=/dev/mtdblock0

            if test -e ${opt_img_file} && test -e @@BOOT_MEDIA@@ ${dev_number}:2 ${opt_img_file}; then
                # Check phram size for opt
                setexpr rest_phram_size ${rest_phram_size} - ${rootfs_img_size}
                setenv rest_phram_size 0x${rest_phram_size};
                size @@BOOT_MEDIA@@ ${dev_number}:2 ${opt_img_file};
                setenv opt_img_size 0x${filesize}

                if test ${rest_phram_size} -ge ${opt_img_size}; then
                    # Load opt image file
                    setexpr opt_img_addr ${rootfs_img_addr} + ${rootfs_img_size}
                    setenv opt_img_addr 0x${opt_img_addr}
                    echo Loading ${opt_img_file}... (addr=${opt_img_addr} size=${opt_img_size})
                    load @@BOOT_MEDIA@@ ${dev_number}:2 ${opt_img_addr} ${opt_img_file};
                    setenv bootargs ${bootargs} mtdblock1=/opt,${opt_img_addr},${opt_img_size}
                else
                    echo Not enough phram size for loading ${opt_img_file}.
                fi;
            else
                echo Not found ${opt_img_file}.
            fi;
        else
            echo Not enough phram size for loading ${rootfs_img_file}.
        fi;
    else
        echo Not found ${rootfs_img_file}.
    fi;
fi;

# Startup Linux Kernel
echo Now boot Linux Kernel...
@@KERNEL_BOOTCMD@@ ${kernel_addr_r} - ${fdt_addr};

